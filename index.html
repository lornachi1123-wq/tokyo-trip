<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ±äº¬å†¬ä¹‹æ—… 2025</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'muji-beige': '#F5F5F0',
                        'muji-sand': '#E8E4D9',
                        'muji-brown': '#8C7E6D',
                        'muji-dark': '#4A4A4A',
                        'muji-accent': '#A68B6A'
                    }
                }
            }
        }
    </script>

    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #F5F5F0; color: #4A4A4A; -webkit-tap-highlight-color: transparent; }
        .tab-content { display: none; }
        .active-tab { display: block; }
        .muji-card { background: white; border-radius: 1.25rem; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .nav-active { color: #A68B6A; }
        ::-webkit-scrollbar { width: 0px; }
        .timeline-line::before {
            content: '';
            position: absolute;
            left: 0.75rem;
            top: 0;
            bottom: 0;
            width: 2px;
            background-color: #E8E4D9;
        }
        details > summary { list-style: none; }
        details > summary::-webkit-details-marker { display: none; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .checkbox-muji { accent-color: #A68B6A; }
    </style>
</head>
<body class="pb-24">

    <header class="sticky top-0 z-50 bg-muji-beige/80 backdrop-blur-md px-6 py-4 flex justify-between items-center border-b border-muji-sand">
        <div>
            <h1 class="text-xl font-bold tracking-tight text-muji-brown italic">TOKYO 2025</h1>
            <p class="text-[10px] text-gray-400">12/25 - 12/31 CI108/CI109</p>
        </div>
        <div class="text-right">
            <span id="header-date" class="text-sm font-medium"></span>
        </div>
    </header>

    <main class="max-w-md mx-auto px-4 mt-6">
        
        <section id="plan" class="tab-content active-tab">
            <div id="weather-widget" class="muji-card p-4 mb-6 bg-gradient-to-br from-blue-50 to-white border border-blue-100">
                <div class="flex justify-between items-center">
                    <div>
                        <h4 id="location-name" class="text-sm font-bold text-blue-800">æ±äº¬å¸‚å€</h4>
                        <p class="text-[10px] text-blue-600">12æœˆå‡æº«: 5Â°C - 12Â°C</p>
                    </div>
                    <a id="weather-link" href="https://www.jma.go.jp/bosai/forecast/#area_code=130000" target="_blank" class="bg-blue-500 text-white text-[10px] px-3 py-1.5 rounded-full font-bold shadow-sm">
                        æŸ¥çœ‹å³æ™‚æ°£è±¡ <i class="fa-solid fa-arrow-up-right-from-square ml-1"></i>
                    </a>
                </div>
                <div id="weather-tips" class="mt-2 text-[11px] text-gray-500 border-t border-blue-50 pt-2 italic leading-relaxed">
                    <i class="fa-solid fa-lightbulb mr-1 text-yellow-500"></i> å¸‚å€é¢¨å¤§æ™‚é«”æ„Ÿè¼ƒå†·ï¼Œå»ºè­°æº–å‚™åœå·¾ã€‚
                </div>
            </div>

            <div class="mb-6">
                <div class="muji-card p-4 space-y-2 border-l-4 border-muji-accent text-[11px]">
                    <div class="flex justify-between">
                        <span><i class="fa-solid fa-plane-departure mr-1 text-muji-accent"></i> 12/25 å»ç¨‹ CI108</span>
                        <span class="font-bold">14:25 â” 18:30</span>
                    </div>
                    <div class="flex justify-between border-t border-muji-sand pt-2">
                        <span><i class="fa-solid fa-plane-arrival mr-1 text-muji-accent"></i> 12/31 å›ç¨‹ CI109</span>
                        <span class="font-bold">19:30 â” 22:45</span>
                    </div>
                </div>
            </div>

            <div class="flex overflow-x-auto pb-4 gap-2 no-scrollbar mb-4">
                <button onclick="showDay(1)" class="day-btn flex-shrink-0 px-5 py-2 muji-card text-xs font-bold" id="day-btn-1">D1</button>
                <button onclick="showDay(2)" class="day-btn flex-shrink-0 px-5 py-2 muji-card text-xs font-bold" id="day-btn-2">D2</button>
                <button onclick="showDay(3)" class="day-btn flex-shrink-0 px-5 py-2 muji-card text-xs font-bold" id="day-btn-3">D3</button>
                <button onclick="showDay(4)" class="day-btn flex-shrink-0 px-5 py-2 muji-card text-xs font-bold" id="day-btn-4">D4</button>
                <button onclick="showDay(5)" class="day-btn flex-shrink-0 px-5 py-2 muji-card text-xs font-bold" id="day-btn-5">D5</button>
                <button onclick="showDay(6)" class="day-btn flex-shrink-0 px-5 py-2 muji-card text-xs font-bold" id="day-btn-6">D6</button>
                <button onclick="showDay(7)" class="day-btn flex-shrink-0 px-5 py-2 muji-card text-xs font-bold" id="day-btn-7">D7</button>
            </div>
            <div id="day-content" class="relative pl-8 timeline-line"></div>
        </section>

        <section id="wallet" class="tab-content">
            <div class="muji-card p-6 mb-4 bg-muji-accent text-white flex justify-between items-end">
                <div>
                    <p class="text-[10px] opacity-80 mb-1">æ—…è¡Œæ”¯å‡ºçµ±è¨ˆ (JPY)</p>
                    <h3 id="total-jpy" class="text-3xl font-bold">Â¥ 0</h3>
                </div>
                <div class="text-right">
                    <p class="text-[10px] opacity-80 mb-1">ç´„å°å¹£ (TWD)</p>
                    <p id="total-twd" class="text-lg font-bold">0</p>
                </div>
            </div>

            <div class="muji-card p-4 mb-4 border border-muji-sand">
                <div class="flex justify-between items-center mb-3">
                    <span class="text-[11px] font-bold text-muji-brown">åŒ¯ç‡è¨­å®š (1 JPY =)</span>
                    <input id="rate-input" type="number" step="0.001" value="0.215" oninput="renderExpenses()" class="w-20 bg-muji-beige rounded px-2 py-1 text-center text-xs font-bold outline-none text-muji-accent">
                </div>
                <div class="relative">
                    <input id="calc-input" type="text" placeholder="è¼¸å…¥ç®—å¼ (å¦‚ 500+200*3)" class="w-full bg-muji-beige rounded-lg p-3 text-sm pr-12 outline-none font-mono">
                    <button onclick="calculateQuick()" class="absolute right-2 top-2 bg-muji-brown text-white px-3 py-1 rounded-md text-xs font-bold">=</button>
                </div>
            </div>

            <div class="muji-card p-4 mb-6 space-y-3 border border-muji-sand">
                <input id="exp-item" type="text" placeholder="å“é …åç¨±" class="w-full bg-muji-beige border-none rounded-lg p-3 text-sm outline-none">
                <div class="flex gap-2">
                    <input id="exp-amount" type="number" placeholder="é‡‘é¡ (JPY)" class="flex-1 bg-muji-beige border-none rounded-lg p-3 text-sm outline-none">
                    <label class="bg-muji-sand text-muji-dark p-3 rounded-lg cursor-pointer flex items-center justify-center w-12 hover:bg-gray-200">
                        <i class="fa-solid fa-camera"></i>
                        <input type="file" accept="image/*" class="hidden" onchange="handleImage(this)">
                    </label>
                </div>
                <div id="img-preview-container" class="hidden relative inline-block">
                    <img id="img-preview" src="" class="w-20 h-20 object-cover rounded-lg border-2 border-muji-accent">
                    <button onclick="clearPreview()" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-5 h-5 text-xs flex items-center justify-center">Ã—</button>
                </div>
                <button onclick="addExpense()" class="w-full bg-muji-accent text-white py-3 rounded-xl font-bold shadow-md">å­˜å…¥è¨˜å¸³æœ¬</button>
            </div>
            <div id="expense-list" class="space-y-3"></div>
        </section>

        <section id="lists" class="tab-content">
            <h2 class="text-lg font-bold mb-4 italic text-muji-brown"><i class="fa-solid fa-square-check mr-2"></i>è¡Œå‰æº–å‚™ CheckList</h2>
            <div id="checklist" class="muji-card p-4 mb-6 space-y-3">
                </div>

            <h2 class="text-lg font-bold mb-4 italic text-muji-brown"><i class="fa-solid fa-pen-nib mr-2"></i>å€‹äººå‚™å¿˜éŒ„</h2>
            <div class="muji-card p-4">
                <textarea id="note-input" rows="8" class="w-full text-sm outline-none leading-relaxed border-none" placeholder="åœ¨æ­¤è¼¸å…¥å…§å®¹ï¼Œç¶²å€å°‡è‡ªå‹•è½‰æ›ç‚ºé€£çµ..."></textarea>
                <div id="link-container" class="mt-4 space-y-2 border-t border-muji-sand pt-3 hidden">
                    <p class="text-[10px] text-gray-400 mb-2 font-bold uppercase tracking-widest">Detected Links</p>
                    <div id="link-list" class="flex flex-wrap gap-2"></div>
                </div>
            </div>
        </section>

        <section id="info" class="tab-content">
            <h2 class="text-lg font-bold mb-4 italic text-muji-brown"><i class="fa-solid fa-phone-flip mr-2"></i>ç·Šæ€¥è¯çµ¡è³‡è¨Š</h2>
            <div class="muji-card p-4 mb-6 space-y-3 text-sm">
                <div class="flex justify-between items-center border-b border-muji-sand pb-2">
                    <span class="text-muji-dark">å ±è­¦ (è­¦å¯Ÿå±€)</span>
                    <a href="tel:110" class="font-bold text-muji-accent">110</a>
                </div>
                <div class="flex justify-between items-center border-b border-muji-sand pb-2">
                    <span class="text-muji-dark">ç«è­¦ã€æ•‘è­·è»Š</span>
                    <a href="tel:119" class="font-bold text-muji-accent">119</a>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-muji-dark text-[12px]">å°åŒ—é§æ—¥ç¶“æ¿Ÿæ–‡åŒ–ä»£è¡¨è™•</span>
                    <a href="tel:0332807811" class="font-bold text-muji-accent">03-3280-7811</a>
                </div>
            </div>

            <h2 class="text-lg font-bold mb-4 italic text-muji-brown"><i class="fa-solid fa-circle-exclamation mr-2"></i>æ—…éŠç¦å¿Œèˆ‡æé†’</h2>
            <div class="muji-card p-4 space-y-4 text-xs leading-relaxed">
                <div>
                    <h4 class="font-bold text-muji-accent mb-1">1. å‡ºå…¥å¢ƒé•ç¦å“</h4>
                    <p class="text-gray-500">çµ•å°ä¸å¯æ”œå¸¶è‚‰è£½å“ï¼ˆæ³¡éºµå«è‚‰å¡Šã€è‚‰ä¹¾ã€å«è‚‰é¬†é›¶é£Ÿï¼‰å…¥å¢ƒã€‚è¿”å°äº¦åŒï¼Œé•è€…ç½°é° NT$20è¬èµ·ã€‚</p>
                </div>
                <div>
                    <h4 class="font-bold text-muji-accent mb-1">2. ç¦®å„€è¦ç¯„</h4>
                    <p class="text-gray-500">æ±äº¬é›»æ‰¶æ¢¯ç¿’æ…£é å·¦ç«™ç«‹ï¼Œå³å´é€šè¡Œã€‚é›»è»Šå…§è«‹å‹¿é€šè©±ï¼Œä¸¦å°‡æ‰‹æ©Ÿè¨­ç‚ºéœéŸ³ã€‚</p>
                </div>
                <div>
                    <h4 class="font-bold text-muji-accent mb-1">3. åº—å®¶æœå‹™</h4>
                    <p class="text-gray-500">çµå¸³æ™‚è«‹å°‡ç¾é‡‘æˆ–å¡ç‰‡æ”¾åœ¨æ”¶éŠ€å°çš„å°æ‰˜ç›¤ (Tray) ä¸Šã€‚å¤šæ•¸åº—å®¶ä¸æ”¶å°è²»ã€‚</p>
                </div>
            </div>
        </section>

    </main>

    <nav class="fixed bottom-0 left-0 right-0 bg-white/90 backdrop-blur-md border-t border-muji-sand px-6 py-3 flex justify-between items-center z-50">
        <button onclick="switchTab('plan', this)" class="nav-item flex flex-col items-center gap-1 nav-active transition-colors">
            <i class="fa-solid fa-calendar-day text-lg"></i>
            <span class="text-[9px] font-bold">è¡Œç¨‹</span>
        </button>
        <button onclick="switchTab('wallet', this)" class="nav-item flex flex-col items-center gap-1 text-gray-300 transition-colors">
            <i class="fa-solid fa-wallet text-lg"></i>
            <span class="text-[9px] font-bold">è¨˜å¸³</span>
        </button>
        <button onclick="switchTab('lists', this)" class="nav-item flex flex-col items-center gap-1 text-gray-300 transition-colors">
            <i class="fa-solid fa-clipboard-list text-lg"></i>
            <span class="text-[9px] font-bold">æ¸…å–®</span>
        </button>
        <button onclick="switchTab('info', this)" class="nav-item flex flex-col items-center gap-1 text-gray-300 transition-colors">
            <i class="fa-solid fa-circle-info text-lg"></i>
            <span class="text-[9px] font-bold">è³‡è¨Š</span>
        </button>
    </nav>

    <script>
        // --- è¡Œç¨‹è³‡æ–™ (ä¿æŒä¸€è‡´) ---
        const itinerary = {
            1: { title: "12/25 (ä¸‰) æŠµé”æ±äº¬", loc: "æ±äº¬", events: [
                { time: "18:30", text: "æŠµé”æˆç”°æ©Ÿå ´ (NRT)", icon: "plane-arrival" },
                { time: "19:15", text: "é ˜å– Skyliner è»Šç¥¨", icon: "ticket", routeDetail: "æ©Ÿå ´ â” Skyliner â” é’ç ¥ç«™ (ä¸‹è»Š) â” è½‰äº¬æˆæŠ¼ä¸Šç·š â” æŠ¼ä¸Šç«™" },
                { time: "21:00", text: "Check-in æŠ¼ä¸Šä½å®¿", icon: "hotel", location: "å¢¨ç”°å€ Narihira 3-4-1" },
                { time: "21:30", text: "æ™šé¤ï¼šå…­å˜èˆ (Rokurinsha)", icon: "utensils", tips: { note: "æœ€å¾Œé»é¤ 21:30ã€‚è‹¥è¶•ä¸ä¸Šå¯åƒæ¾å±‹æˆ–è¶…å•†ã€‚" } }
            ]},
            2: { title: "12/26 (å››) è¿ªå£«å°¼æ¨‚åœ’", loc: "æ±äº¬", events: [
                { time: "07:45", text: "å‡ºç™¼ â” è¿ªå£«å°¼", icon: "train", routeDetail: "æŠ¼ä¸Š (åŠè—é–€ç·šå¾€æ¸‹è°·) â” æ¸…æ¾„ç™½æ²³ (è½‰æ—¥æ¯”è°·ç·š) â” å…«ä¸å € (è½‰JRäº¬è‘‰ç·š) â” èˆæ¿±ç«™", tips: { note: "å‡ºç«™è«‹èµ°å—å£ (South Exit)ã€‚" } },
                { time: "09:00", text: "æ±äº¬è¿ªå£«å°¼å…¥åœ’", icon: "fort-awesome", tips: { go: "ç«‹å³æ¶ DPA: ç¾å¥³èˆ‡é‡ç¸ / ç¿±ç¿” / ç©å…·ç¸½å‹•å“¡" } },
                { time: "21:00", text: "ç…™ç«ç§€èˆ‡å›ç¨‹", icon: "fireworks" },
                { time: "22:30", text: "å›ä½å®¿ä¼‘æ¯", icon: "moon" }
            ]},
            3: { title: "12/27 (äº”) æ·ºè‰èˆ‡éŠ€åº§è³¼ç‰©", loc: "æ±äº¬", events: [
                { time: "09:00", text: "å‡ºç™¼ â” æ·ºè‰", icon: "camera", routeDetail: "æŠ¼ä¸Š (éƒ½ç‡Ÿæ·ºè‰ç·š) â” æ·ºè‰ç«™ A4 å‡ºå£ (å‡ºç«™å³é›·é–€)", tips: { go: "10:00 æ·ºè‰æ„›å’Œæœ3è™Ÿåº—" } },
                { time: "13:00", text: "åˆé¤ï¼šæ·ºè‰ä»ŠåŠ (å£½å–œç‡’)", icon: "utensils" },
                { time: "14:30", text: "å°ç¶±ç¥ç¤¾", icon: "shrine", routeDetail: "æ·ºè‰ç·š â” äººå½¢ç”º/æ—¥æœ¬æ©‹" },
                { time: "16:00", text: "éŠ€åº§è³¼ç‰©å¤§é›†åˆ", icon: "bag-shopping", tips: { shop: "Loft, MUJIæ——è‰¦åº—, Uniqloæ±äº¬, noixè²»å—é›ª(ä¸‰è¶ŠB2F)", eat: "19:30 èŠ±å±±ã†ã©ã‚“ (æ‹¿è™Ÿç¢¼ç‰Œ)" } }
            ]},
            4: { title: "12/28 (å…­) å‡ºç™¼å¯Œå£«å±±", loc: "æ²³å£æ¹–", events: [
                { time: "08:30", text: "è¡Œæå¯„æ”¾æ–°å®¿ç«™", icon: "suitcase", tips: { note: "åƒ…æ”œå¸¶è¼•ä¾¿è¡Œæå‰å¾€æ²³å£æ¹–ã€‚" } },
                { time: "10:00", text: "å¯Œå£«æ€¥é«˜é€Ÿå·´å£«", icon: "bus", routeDetail: "æ–°å®¿å·´å£«ç¸½ç«™ â” æ²³å£æ¹– (ç´„2å°æ™‚)" },
                { time: "12:00", text: "æŠµé”æ²³å£æ¹– / åˆé¤", icon: "utensils", tips: { eat: "Hoto Fudo ä¸å‹•èŒ¶å±‹ é¤ºé¤ºéºµ" } },
                { time: "14:00", text: "å¤©ä¸Šå±±å…¬åœ’çºœè»Š", icon: "mountain", tips: { go: "æ­¥è¡Œ 20 åˆ†æˆ–æ­ Retro Bus ç´…ç·šã€‚" } },
                { time: "15:30", text: "å¤§çŸ³å…¬åœ’ / ç”Ÿæ´»é¤¨", icon: "camera", tips: { eat: "BRAND NEWDAY æŠ«è–©ç”œé»" } },
                { time: "18:00", text: "å…¥ä½é£¯åº—", icon: "hotel", location: "æ²³å£æ¹–ç”º Asakawa 180-1" }
            ]},
            5: { title: "12/29 (æ—¥) å¯Œå£«å±±ä¸‹å‰ç”°", loc: "æ²³å£æ¹–", events: [
                { time: "09:10", text: "å‰å¾€ä¸‹å‰ç”°", icon: "train", routeDetail: "æ²³å£æ¹–ç«™æ­ä¹˜å¯Œå£«æ€¥è¡Œç·šé›»è»Š" },
                { time: "09:25", text: "æ–°å€‰å¯Œå£«æ·ºé–“ç¥ç¤¾", icon: "camera", tips: { go: "æ‹æ”äº”é‡å¡” + å¯Œå£«å±±ç¶“å…¸ç•«é¢" } },
                { time: "11:00", text: "æœ¬ç”ºäºŒä¸ç›®å•†åº—è¡—", icon: "camera", tips: { note: "è‘—åçš„å¯Œå£«å±±è¡—æ™¯æ‹æ”é»èˆ‡åˆé¤ã€‚" } },
                { time: "16:00", text: "æ­å·´å£«è¿”å›æ–°å®¿", icon: "bus" },
                { time: "18:30", text: "æ™šé¤ï¼šç‡’è‚‰ Bondz", icon: "fire-burner" },
                { time: "21:30", text: "Check-in æ–°å°å²©ä½å®¿", icon: "hotel", location: "æ±Ÿæˆ¸å·åŒºæ¾å³¶4-45-5" }
            ]},
            6: { title: "12/30 (ä¸€) ä¸Šé‡èˆ‡æ¾€è°·", loc: "æ±äº¬", events: [
                { time: "10:00", text: "ä¸Šé‡é˜¿ç¾æ©«ä¸", icon: "cart-shopping", tips: { shop: "äºŒæœ¨ä¹‹è“å­ã€æ¾æœ¬æ¸…ã€å”å‰è¨¶å¾·", eat: "å±±å®¶ç‚¸è±¬æ’" } },
                { time: "14:00", text: "æ¾€è°· Shibuya Sky", icon: "mountain-sun", tips: { go: "è—ç“¶å’–å•¡ã€å“¥å‰æ‹‰å•†åº—", eat: "æ™šé¤ï¼šé°»å¯Œå£« (ç‚­ç„¼ ã†ãªå¯Œå£«)" } },
                { time: "22:00", text: "å›æ–°å°å²©ä¼‘æ¯", icon: "moon" }
            ]},
            7: { title: "12/31 (äºŒ) å…ç¨…åº—èˆ‡å›å®¶", loc: "æ±äº¬", events: [
                { time: "11:00", text: "é€€æˆ¿ / æ–°å°å²©æ—©åˆé¤", icon: "coffee" },
                { time: "14:30", text: "å‡ºç™¼å¾€æ©Ÿå ´", icon: "plane", tips: { shop: "æ©Ÿå ´å…ç¨…åº— (é ç•™2å°æ™‚): è²»å—é›ª, Shake Shack" } },
                { time: "19:30", text: "CI109 èµ·é£›", icon: "plane-up" },
                { time: "02:00", text: "å›åˆ°æº«æš–çš„å®¶", icon: "house-user" }
            ]}
        };

        const weatherInfo = {
            "æ±äº¬": { url: "https://www.jma.go.jp/bosai/forecast/#area_code=130000", avg: "5Â°C - 12Â°C", tips: "<i class='fa-solid fa-lightbulb mr-1 text-yellow-500'></i> å¸‚å€é¢¨å¤§æ™‚é«”æ„Ÿè¼ƒå†·ï¼Œå»ºè­°æº–å‚™åœå·¾ã€‚" },
            "æ²³å£æ¹–": { url: "https://www.jma.go.jp/bosai/forecast/#area_code=190000", avg: "-3Â°C - 8Â°C", tips: "<i class='fa-solid fa-snowflake mr-1 text-blue-400'></i> å±±å€æ°£æº«æ¥µä½ï¼å¿…é ˆæº–å‚™æš–æš–åŒ…ã€æ‰‹å¥—èˆ‡åšæ¯›å¸½ã€‚" }
        };

        let expenses = JSON.parse(localStorage.getItem('trip_expenses_v3')) || [];
        let checkData = JSON.parse(localStorage.getItem('trip_checklist_v3')) || [
            { text: "è­·ç…§ã€æ—¥å¹£ã€ä¿¡ç”¨å¡", checked: false },
            { text: "Visit Japan Web æˆªåœ–", checked: false },
            { text: "ä¿æš–è¡£ç‰©èˆ‡æš–æš–åŒ…", checked: false },
            { text: "ç¶²å¡èˆ‡è¡Œå‹•é›»æº", checked: false },
            { text: "è¿ªå£«å°¼/å±•æœ›å° QR Code", checked: false }
        ];
        let currentImgBase64 = null;

        function switchTab(tabId, el) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active-tab'));
            document.getElementById(tabId).classList.add('active-tab');
            document.querySelectorAll('.nav-item').forEach(n => {
                n.classList.remove('nav-active', 'text-muji-accent');
                n.classList.add('text-gray-300');
            });
            el.classList.remove('text-gray-300');
            el.classList.add('nav-active', 'text-muji-accent');
            window.scrollTo(0,0);
        }

        function showDay(dayNum) {
            const content = document.getElementById('day-content');
            const data = itinerary[dayNum];
            document.querySelectorAll('.day-btn').forEach(b => {
                b.classList.remove('bg-muji-accent', 'text-white');
                b.classList.add('bg-white', 'text-muji-brown');
            });
            const activeBtn = document.getElementById(`day-btn-${dayNum}`);
            activeBtn.classList.add('bg-muji-accent', 'text-white');

            const loc = data.loc;
            document.getElementById('location-name').innerText = loc + " å³æ™‚é å ±";
            document.getElementById('weather-link').href = weatherInfo[loc].url;
            document.getElementById('weather-tips').innerHTML = weatherInfo[loc].tips;
            document.querySelector('#weather-widget p').innerText = `12æœˆå‡æº«: ${weatherInfo[loc].avg}`;

            let html = `<h3 class="text-sm font-bold text-muji-accent mb-6 tracking-widest uppercase">${data.title}</h3>`;
            data.events.forEach(ev => {
                // ç”¢ç”Ÿ Google Map æœå°‹é€£çµ
                const searchLabel = ev.location ? ev.location : ev.text;
                const mapLink = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(searchLabel)}`;

                html += `
                <div class="mb-8 relative">
                    <a href="${mapLink}" target="_blank" class="absolute -left-[42px] top-0 w-8 h-8 bg-white rounded-full border border-muji-sand flex items-center justify-center text-muji-brown shadow-sm active:scale-95 transition-transform z-10">
                        <i class="fa-solid fa-map-location-dot text-xs"></i>
                    </a>

                    <div class="absolute -left-[27px] top-1 w-3 h-3 bg-muji-accent rounded-full border-2 border-white shadow-sm"></div>
                    <div class="muji-card p-4">
                        <div class="flex items-start gap-3">
                            <div class="text-[10px] font-bold text-muji-brown w-10 mt-1">${ev.time}</div>
                            <div class="flex-1 text-sm">
                                <p class="font-bold text-muji-dark leading-tight">${ev.text}</p>
                                ${ev.routeDetail ? `<p class="text-[10px] text-muji-brown mt-2 bg-muji-beige p-2 rounded leading-relaxed border border-muji-sand/50"><i class="fa-solid fa-map-signs mr-1"></i>${ev.routeDetail}</p>` : ''}
                                ${ev.location ? `<p class="text-[10px] text-gray-400 mt-2"><i class="fa-solid fa-location-dot mr-1"></i>${ev.location}</p>` : ''}
                                ${ev.tips ? `
                                <details class="mt-3 border-t border-muji-sand/30 pt-2">
                                    <summary class="text-[10px] text-muji-accent font-bold cursor-pointer flex items-center justify-between">æ™¯é»èˆ‡ç¾é£Ÿç­†è¨˜ <i class="fa-solid fa-chevron-down text-[8px]"></i></summary>
                                    <div class="mt-2 space-y-2 text-[10px] text-gray-500 bg-muji-beige/30 p-2 rounded-lg">
                                        ${ev.tips.go ? `<p>ğŸ“ <strong>å¿…å»ï¼š</strong>${ev.tips.go}</p>` : ''}
                                        ${ev.tips.eat ? `<p>ğŸ± <strong>å¿…åƒï¼š</strong>${ev.tips.eat}</p>` : ''}
                                        ${ev.tips.shop ? `<p>ğŸ›ï¸ <strong>å¿…é€›ï¼š</strong>${ev.tips.shop}</p>` : ''}
                                        ${ev.tips.note ? `<p>ğŸ’¡ <strong>æé†’ï¼š</strong>${ev.tips.note}</p>` : ''}
                                    </div>
                                </details>` : ''}
                            </div>
                        </div>
                    </div>
                </div>`;
            });
            content.innerHTML = html;
        }

        // --- WALLET é‚è¼¯ ---
        function calculateQuick() {
            const input = document.getElementById('calc-input');
            try {
                const res = new Function(`return ${input.value}`)();
                document.getElementById('exp-amount').value = Math.round(res);
            } catch(e) { alert("ç®—å¼éŒ¯èª¤"); }
        }

        function handleImage(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        const maxW = 300;
                        const scale = maxW / img.width;
                        canvas.width = maxW;
                        canvas.height = img.height * scale;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        currentImgBase64 = canvas.toDataURL('image/jpeg', 0.6);
                        document.getElementById('img-preview').src = currentImgBase64;
                        document.getElementById('img-preview-container').classList.remove('hidden');
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function clearPreview() {
            currentImgBase64 = null;
            document.getElementById('img-preview-container').classList.add('hidden');
        }

        function addExpense() {
            const item = document.getElementById('exp-item').value;
            const amount = parseFloat(document.getElementById('exp-amount').value);
            if(!item || !amount) return;
            expenses.unshift({ id: Date.now(), item, amount, img: currentImgBase64, date: new Date().toLocaleString() });
            localStorage.setItem('trip_expenses_v3', JSON.stringify(expenses));
            renderExpenses();
            document.getElementById('exp-item').value = '';
            document.getElementById('exp-amount').value = '';
            document.getElementById('calc-input').value = '';
            clearPreview();
        }

        function renderExpenses() {
            const list = document.getElementById('expense-list');
            const rate = parseFloat(document.getElementById('rate-input').value) || 0.215;
            let total = 0;
            list.innerHTML = expenses.map(ex => {
                total += ex.amount;
                return `<div class="muji-card p-4 flex gap-3 items-center">
                    ${ex.img ? `<img src="${ex.img}" class="w-12 h-12 object-cover rounded-md">` : `<div class="w-12 h-12 bg-muji-beige rounded-md flex items-center justify-center text-muji-sand"><i class="fa-solid fa-receipt"></i></div>`}
                    <div class="flex-1">
                        <p class="text-sm font-bold text-muji-dark">${ex.item}</p>
                        <p class="text-[9px] text-gray-400">${ex.date}</p>
                    </div>
                    <div class="text-right">
                        <p class="text-sm font-bold text-muji-brown">Â¥ ${ex.amount.toLocaleString()}</p>
                        <p class="text-[10px] text-gray-400">â‰ˆ NT$ ${Math.round(ex.amount * rate).toLocaleString()}</p>
                        <button onclick="deleteExp(${ex.id})" class="text-[9px] text-red-300">åˆªé™¤</button>
                    </div>
                </div>`;
            }).join('');
            document.getElementById('total-jpy').innerText = `Â¥ ${total.toLocaleString()}`;
            document.getElementById('total-twd').innerText = `${Math.round(total * rate).toLocaleString()}`;
        }

        function deleteExp(id) {
            expenses = expenses.filter(e => e.id !== id);
            localStorage.setItem('trip_expenses_v3', JSON.stringify(expenses));
            renderExpenses();
        }

        // --- LISTS é‚è¼¯ ---
        function renderChecklist() {
            const container = document.getElementById('checklist');
            container.innerHTML = checkData.map((item, idx) => `
                <div class="flex items-center gap-3">
                    <input type="checkbox" ${item.checked ? 'checked' : ''} onchange="toggleCheck(${idx})" class="checkbox-muji w-4 h-4">
                    <span class="text-sm ${item.checked ? 'line-through text-gray-300' : 'text-muji-dark'}">${item.text}</span>
                </div>
            `).join('');
        }

        function toggleCheck(idx) {
            checkData[idx].checked = !checkData[idx].checked;
            localStorage.setItem('trip_checklist_v3', JSON.stringify(checkData));
            renderChecklist();
        }

        const noteInput = document.getElementById('note-input');
        function scanLinks(text) {
            const urlRegex = /(https?:\/\/[^\s]+)/g;
            const matches = text.match(urlRegex);
            const container = document.getElementById('link-container');
            const list = document.getElementById('link-list');
            if (matches) {
                container.classList.remove('hidden');
                list.innerHTML = [...new Set(matches)].map(url => `
                    <a href="${url}" target="_blank" class="bg-muji-beige text-muji-accent text-[10px] px-3 py-1.5 rounded-full border border-muji-sand flex items-center gap-1 max-w-[150px] truncate font-bold">
                        <i class="fa-solid fa-link"></i> é–‹å•Ÿé€£çµ
                    </a>
                `).join('');
            } else {
                container.classList.add('hidden');
            }
        }

        noteInput.addEventListener('input', (e) => {
            localStorage.setItem('trip_notes_v3', e.target.value);
            scanLinks(e.target.value);
        });

        window.onload = () => {
            document.getElementById('header-date').innerText = new Date().toLocaleDateString();
            showDay(1);
            renderExpenses();
            renderChecklist();
            const savedNote = localStorage.getItem('trip_notes_v3') || '';
            noteInput.value = savedNote;
            scanLinks(savedNote);
        };
    </script>
</body>
</html>
